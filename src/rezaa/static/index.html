<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rezaa AI - Video Editor</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #0f1117;
    color: #e1e4e8;
    min-height: 100vh;
    display: flex;
    justify-content: center;
    padding: 2rem 1rem;
  }
  .container { max-width: 640px; width: 100%; }
  h1 { font-size: 1.75rem; text-align: center; margin-bottom: .25rem; }
  h1 span { color: #7c3aed; }
  .subtitle { text-align: center; color: #8b949e; font-size: .9rem; margin-bottom: 2rem; }
  .step {
    background: #161b22;
    border: 1px solid #30363d;
    border-radius: 12px;
    padding: 1.25rem;
    margin-bottom: 1rem;
  }
  .step-header {
    display: flex;
    align-items: center;
    gap: .5rem;
    margin-bottom: .75rem;
    font-weight: 600;
    font-size: 1rem;
  }
  .step-number {
    background: #7c3aed;
    color: #fff;
    width: 24px; height: 24px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: .75rem;
    flex-shrink: 0;
  }
  .drop-zone {
    border: 2px dashed #30363d;
    border-radius: 8px;
    padding: 2rem 1rem;
    text-align: center;
    cursor: pointer;
    transition: border-color .2s, background .2s;
    color: #8b949e;
    font-size: .9rem;
  }
  .drop-zone:hover, .drop-zone.drag-over {
    border-color: #7c3aed;
    background: rgba(124,58,237,.08);
  }
  .drop-zone input { display: none; }
  .status-msg {
    margin-top: .5rem;
    font-size: .85rem;
    min-height: 1.2em;
  }
  .status-msg.ok { color: #3fb950; }
  .status-msg.err { color: #f85149; }
  label { display: block; font-size: .85rem; color: #8b949e; margin-bottom: .25rem; }
  select, input[type="number"] {
    width: 100%;
    padding: .5rem .75rem;
    background: #0d1117;
    border: 1px solid #30363d;
    border-radius: 6px;
    color: #e1e4e8;
    font-size: .9rem;
    margin-bottom: .75rem;
  }
  select:focus, input[type="number"]:focus { outline: none; border-color: #7c3aed; }
  .pref-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0 .75rem; }
  button.primary {
    width: 100%;
    padding: .75rem;
    background: #7c3aed;
    color: #fff;
    border: none;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: opacity .2s;
  }
  button.primary:hover { opacity: .9; }
  button.primary:disabled { opacity: .5; cursor: not-allowed; }
  .progress-section { display: none; }
  .progress-section.visible { display: block; }
  .progress-bar-outer {
    background: #21262d;
    border-radius: 6px;
    height: 10px;
    overflow: hidden;
    margin: .75rem 0 .5rem;
  }
  .progress-bar-inner {
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, #7c3aed, #a78bfa);
    border-radius: 6px;
    transition: width .4s ease;
  }
  .progress-label {
    display: flex;
    justify-content: space-between;
    font-size: .85rem;
    color: #8b949e;
  }
  .download-section { display: none; text-align: center; margin-top: 1rem; }
  .download-section.visible { display: block; }
  .download-section a {
    display: inline-block;
    padding: .75rem 2rem;
    background: #238636;
    color: #fff;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 600;
    font-size: 1rem;
    transition: opacity .2s;
  }
  .download-section a:hover { opacity: .9; }
</style>
</head>
<body>
<div class="container">
  <h1><span>Rezaa</span> AI</h1>
  <p class="subtitle">Intelligent multi-agent video editing</p>

  <!-- Step 1: Upload Audio -->
  <div class="step">
    <div class="step-header"><span class="step-number">1</span> Upload Audio</div>
    <div class="drop-zone" id="audio-drop">
      <input type="file" id="audio-input" accept=".mp3,.wav,.aac,.m4a">
      Drop audio file here or click to browse<br><small>mp3, wav, aac, m4a</small>
    </div>
    <div class="status-msg" id="audio-status"></div>
  </div>

  <!-- Step 2: Upload Videos -->
  <div class="step">
    <div class="step-header"><span class="step-number">2</span> Upload Video Clips</div>
    <div class="drop-zone" id="video-drop">
      <input type="file" id="video-input" accept=".mp4,.mov,.avi,.webm" multiple>
      Drop video files here or click to browse<br><small>mp4, mov, avi, webm &mdash; multiple allowed</small>
    </div>
    <div class="status-msg" id="video-status"></div>
  </div>

  <!-- Step 3: Preferences -->
  <div class="step">
    <div class="step-header"><span class="step-number">3</span> Preferences</div>
    <div class="pref-grid">
      <div>
        <label for="pacing">Pacing</label>
        <select id="pacing">
          <option value="fast">Fast</option>
          <option value="medium" selected>Medium</option>
          <option value="slow">Slow</option>
        </select>
      </div>
      <div>
        <label for="style">Style</label>
        <select id="style">
          <option value="dramatic">Dramatic</option>
          <option value="smooth" selected>Smooth</option>
          <option value="energetic">Energetic</option>
        </select>
      </div>
      <div>
        <label for="transition">Transition</label>
        <select id="transition">
          <option value="cut" selected>Cut</option>
          <option value="fade">Fade</option>
          <option value="crossfade">Crossfade</option>
        </select>
      </div>
      <div>
        <label for="duration">Target Duration (s)</label>
        <input type="number" id="duration" value="30" min="5" max="600" step="1">
      </div>
    </div>
  </div>

  <!-- Step 4: Create Reel -->
  <div class="step">
    <div class="step-header"><span class="step-number">4</span> Create Reel</div>
    <button class="primary" id="create-btn" disabled>Create Reel</button>
    <div class="status-msg" id="process-status"></div>

    <div class="progress-section" id="progress-section">
      <div class="progress-bar-outer"><div class="progress-bar-inner" id="progress-bar"></div></div>
      <div class="progress-label">
        <span id="progress-stage">Waiting...</span>
        <span id="progress-pct">0%</span>
      </div>
      <div class="status-msg" id="progress-msg"></div>
    </div>

    <div class="download-section" id="download-section">
      <a id="download-link" href="#">Download Reel</a>
    </div>
  </div>
</div>

<script>
(function() {
  let jobId = null;
  let clipCount = 0;
  let pollTimer = null;

  const $ = id => document.getElementById(id);

  // --- Drop zone wiring ---
  function setupDrop(zoneId, inputId, handler) {
    const zone = $(zoneId);
    const input = $(inputId);
    zone.addEventListener('click', () => input.click());
    zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('drag-over'); });
    zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
    zone.addEventListener('drop', e => {
      e.preventDefault();
      zone.classList.remove('drag-over');
      handler(e.dataTransfer.files);
    });
    input.addEventListener('change', () => { if (input.files.length) handler(input.files); });
  }

  function setStatus(id, text, ok) {
    const el = $(id);
    el.textContent = text;
    el.className = 'status-msg ' + (ok ? 'ok' : 'err');
  }

  function updateCreateBtn() {
    $('create-btn').disabled = !(jobId && clipCount > 0);
  }

  // --- Upload Audio ---
  async function handleAudio(files) {
    const file = files[0];
    const form = new FormData();
    form.append('file', file);
    setStatus('audio-status', 'Uploading...', true);
    try {
      const res = await fetch('/api/v1/upload/audio', { method: 'POST', body: form });
      const data = await res.json();
      if (!res.ok) throw new Error(data.detail || data.message || 'Upload failed');
      jobId = data.job_id;
      clipCount = 0;
      setStatus('video-status', '', true);
      $('progress-section').classList.remove('visible');
      $('download-section').classList.remove('visible');
      setStatus('audio-status', `${data.filename} uploaded (Job: ${jobId})`, true);
    } catch (e) {
      setStatus('audio-status', e.message, false);
    }
    updateCreateBtn();
  }

  // --- Upload Videos ---
  async function handleVideos(files) {
    if (!jobId) { setStatus('video-status', 'Upload audio first to create a job', false); return; }
    setStatus('video-status', `Uploading ${files.length} clip(s)...`, true);
    try {
      for (const file of files) {
        const form = new FormData();
        form.append('file', file);
        const res = await fetch(`/api/v1/upload/video?job_id=${jobId}`, { method: 'POST', body: form });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || data.message || 'Upload failed');
        clipCount = data.clip_count;
      }
      setStatus('video-status', `${clipCount} clip(s) uploaded`, true);
    } catch (e) {
      setStatus('video-status', e.message, false);
    }
    updateCreateBtn();
  }

  // --- Process ---
  async function createReel() {
    const btn = $('create-btn');
    btn.disabled = true;
    setStatus('process-status', '', true);
    $('download-section').classList.remove('visible');

    const prefs = {
      pacing: $('pacing').value,
      style: $('style').value,
      transition_type: $('transition').value,
    };
    const dur = $('duration').value;
    if (dur) prefs.target_duration = parseFloat(dur);

    try {
      const res = await fetch('/api/v1/process', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ job_id: jobId, preferences: prefs }),
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.detail || data.message || 'Process failed');
      setStatus('process-status', 'Processing started...', true);
      $('progress-section').classList.add('visible');
      startPolling();
    } catch (e) {
      setStatus('process-status', e.message, false);
      btn.disabled = false;
    }
  }

  // --- Polling ---
  function startPolling() {
    if (pollTimer) clearInterval(pollTimer);
    pollTimer = setInterval(pollStatus, 2000);
    pollStatus();
  }

  async function pollStatus() {
    try {
      const res = await fetch(`/api/v1/status/${jobId}`);
      const data = await res.json();
      if (!res.ok) throw new Error(data.detail || 'Status check failed');

      const pct = Math.round(data.progress * 100);
      $('progress-bar').style.width = pct + '%';
      $('progress-pct').textContent = pct + '%';
      $('progress-stage').textContent = formatStage(data.stage);
      $('progress-msg').textContent = data.message || '';
      $('progress-msg').className = 'status-msg ok';

      if (data.stage === 'complete') {
        clearInterval(pollTimer);
        pollTimer = null;
        $('progress-bar').style.width = '100%';
        $('progress-pct').textContent = '100%';
        $('progress-msg').textContent = 'Reel complete!';
        $('download-link').href = `/api/v1/download/${jobId}`;
        $('download-section').classList.add('visible');
      } else if (data.stage === 'failed' || data.stage === 'cancelled') {
        clearInterval(pollTimer);
        pollTimer = null;
        $('progress-msg').textContent = data.error || `Processing ${data.stage}`;
        $('progress-msg').className = 'status-msg err';
        $('create-btn').disabled = false;
      }
    } catch (e) {
      $('progress-msg').textContent = e.message;
      $('progress-msg').className = 'status-msg err';
    }
  }

  function formatStage(s) {
    return s.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
  }

  // --- Init ---
  setupDrop('audio-drop', 'audio-input', handleAudio);
  setupDrop('video-drop', 'video-input', handleVideos);
  $('create-btn').addEventListener('click', createReel);
})();
</script>
</body>
</html>
